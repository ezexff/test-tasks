# Задание

Тестовое задание

Программист С++

Разработать на C++ TCP прокси-сервер для СУБД Postgresql с возможностью логирования всех SQL запросов, проходящих через него. Документация по сетевому протоколу этой СУБД доступна на официальном сайте.

Для выполнения тестового задания нужно использовать Berkley sockets (select/poll/epoll).

Прочих зависимостей быть не должно.

Прокси должен уметь обрабатывать большое количество соединений без создания потока (thread) на каждое соединение. Необходимо распарсить сетевые пакеты, проходящие через прокси, в которых содержатся SQL запросы, извлечь эти запросы из пакетов и записать их в файл в виде текста (по одному запросу в строке, структура неважна). Для того, чтобы в прокси были видны SQL запросы в незашифрованном виде, необходимо отключить SSL (на клиенте и/или сервере). Должна присутствовать минимальная обработка ошибок, так же желательны комментарии в тех местах, где возможны ошибки. Приложение не должно падать на нескольких десятках одновременных соединений, выполняющих запросы к СУБД без перерыва в течение 5 минут (можно использовать sysbench для тестирования). Операционная система Linux, компилятор – GCC, так же необходимо создать файл для сборки проекта с помощью cmake или make.
 
Цель выполнения тестового задания – проверка профессиональных навыков кандидатов на вакантную позицию. Написанный Вами код не будет использоваться в продуктах компании или передан третьим лицам. Результат выполнения тестового задания можно выложить на github.com под любой лицензией во избежание использования Вашего кода.


# Краткое описание выполнения задачи

1. Скачал и установил Ubuntu 24.04.3 desktop amd64 на виртуальную машину VMWare
2. Установил ПО необходимое для разработки
```
sudo apt install gcc
sudo apt install g++
sudo apt install make
sudo apt install cmake
sudo apt install code
sudo apt install default-jre
sudo apt install default-jdk
sudo apt install gdb
sudo apt install postgresql
sudo apt install sysbench
sudo apt install dbeaver-ce
sudo apt install wireshark
```
3. Создал в каталоге `/code` батники для сборки программы и отладки (`build.sh` и `debug.sh`)
4. Настроил по [руководству](https://documentation.ubuntu.com/server/how-to/databases/install-postgresql/) PostgreSQL и создал новую базу данных `test`
5. В файле `postgresql.conf` поменял значение `ssl = off`
6. Написал sysbench тесты по [видео с конференции](https://www.youtube.com/watch?v=o3Y9emQ7S6w) и  [по руководству, где описаны параметры](https://github.com/akopytov/sysbench?tab=readme-ov-file#general-command-line-options). Тесты находятся в каталоге `/tests`. Скрипт с тестом в файле `test.lua`. Батники тестирования базы данных в файлах `dprepare.sh`, `drun.sh` и `dcleanup.sh`. Батники тестирования прокси-сервера в файлах `tprepare.sh`, `trun.sh` и `tcleanup.sh`
8. В [официальном руководстве](https://postgrespro.ru/docs/postgresql/current/protocol-overview#PROTOCOL-MESSAGE-CONCEPTS) описана структура сообщения (1ый байт тип сообщения, следующие 4 байта длина без учёта байта типа и далее само сообщение). Опираясь на эту информацию, при помощи Wireshark, определил идентификатор SQL-запроса (байт `0x51`). Чтобы исключить лишние пакеты использовал фильтр:
```
(ip.addr==127.0.0.1 and ((tcp.port==5432) or (tcp.port==5433)))
```
9. Реализовал прокси-сервер с использованием [epoll](https://ru.wikipedia.org/wiki/Epoll)
10. Протестировал приложение при помощи `sysbench` используя батник `trun.sh` (50 соединений, 5 минут и максимальное число запросов). Программа успешно прошла нагрузку